name: Prevent Supabase Pause

# Ejecutar cada d√≠a a las 03:00 UTC (00:00 ART)
on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch: # Permite ejecuci√≥n manual

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Supabase client
        run: npm install @supabase/supabase-js --no-audit --no-fund

      - name: Ping Supabase Database
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          node -e "
            (async () => {
              const { createClient } = require('@supabase/supabase-js');
              
              if (!process.env.SUPABASE_URL || !process.env.SUPABASE_KEY) {
                console.error('‚ùå Faltan variables de entorno');
                process.exit(1);
              }
              
              const supabase = createClient(
                process.env.SUPABASE_URL, 
                process.env.SUPABASE_KEY
              );
              
              try {
                // Hacer una consulta simple a la base de datos
                const { data, error } = await supabase
                  .from('contactos')
                  .select('id')
                  .limit(1);
                
                if (error) {
                  console.error('‚ùå Error al hacer ping:', error.message);
                  process.exit(1);
                }
                
                console.log('‚úÖ Supabase respondi√≥ correctamente');
                console.log('üìä Conexi√≥n activa - Base de datos operativa');
                console.log('‚è∞ Timestamp:', new Date().toISOString());
              } catch (err) {
                console.error('‚ùå Error inesperado:', err.message);
                process.exit(1);
              }
            })();
          "

      - name: Report Status
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "‚úÖ Keep-alive exitoso"
          else
            echo "‚ùå Keep-alive fall√≥"
          fi